# Wastewater Genomic Analysis for SARS-CoV2 Lineage determination

A collection of scripts that UPHL uses to analyze wastewater sequencing data.



This repository provides a series of bash scripts to analyze wastewater sequencing data to determine SARS-CoV2 lineages and their abundance. These scripts set up the required directory structure for analysis, run bioinformatics analysis, and generate submission folders for NCBI. 

The process involves executing the following bash scripts in the given order:
- `WWP_seq_new_run_auto.sh`
- `run_viralrecon.sh`
- `run_freyja_vrn_noBoot_singularity.sh`

## Prerequisites

- Bash
- [Nextflow](https://www.nextflow.io/)
- [ViralRecon](https://github.com/nf-core/viralrecon)
- [Freyja](https://quay.io/repository/uphl/freyja)
- Access to sequencing results directory `/Volumes/IDGenomics_NAS/wastewater_sequencing/`

## Setup and Run Bioinformatics Analysis

### Step 1: Execute WWP_seq_new_run_auto.sh
Execute the bash script with the sequencing `run_name` as an argument:

```bash
sh WWP_seq_new_run_auto.sh <wastewater sequencing run_name> | tee -a WWP_seq_new_run_auto.sh.log
```

This script initializes the sequencing run analysis. It checks whether the fastq generation step is completed, sets up the required directory structure for analysis, moves any failed samples to a dedicated directory, renames fastq files for downstream analysis, and prepares fastq files for NCBI submission.

This script also generates a csv file with NCBI submission ID and associated fastq file names which are used for generating NCBI submission templates.

### Step 2: Execute run_viralrecon.sh
Execute the bash script with the sequencing `run_name` as an argument:

```bash
sh run_viralrecon.sh <wastewater sequencing run_name> | tee -a viralrecon.log
```

This script executes the [ViralRecon](https://github.com/nf-core/viralrecon) pipeline with wastewater sequencing data. It checks and creates an input samplesheet required to run the ViralRecon pipeline, runs the pipeline, and copies the resulting files to a dedicated `results` directory.

This script also cleans up the workspace by removing the `work` directory.

### Step 3: Execute run_freyja_vrn_noBoot_singularity.sh
Execute the bash script with the sequencing `run_name` as an argument:

```bash
sh run_freyja_vrn_noBoot_singularity.sh <wastewater sequencing run_name> | tee -a freyja.log
```

This script retrieves BAM files for each sample generated by the ViralRecon tool and performs Freyja analysis. It uses BAM files after the ivar primer trimming step and generates Freyja demultiplexed lineage data. It then aggregates the lineage data and creates a lineage plot. Finally, it copies the aggregated lineage results to the `results` directory.

## Note

You need to adjust the `SINGULARITY_CACHEDIR` and `NXF_SINGULARITY_CACHEDIR` environment variables according to your system configuration in the `run_viralrecon.sh` script.

The ViralRecon pipeline requires a configuration file (`UPHL_viralrecon.config`), parameters file (`UPHL_viralrecon_params.yml`), and MultiQC configuration file (`new_multiqc_config.yaml`). These should be located in `../conf-files/` directory relative to where the script is run.

The Freyja tool requires the `uphl-freyja-latest.simg` Singularity container image. This image can be pulled from the Quay ('https://quay.io/repository/uphl/freyja')
